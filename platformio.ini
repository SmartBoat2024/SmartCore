; ============================================================
; PlatformIO Project Configuration File
;
; This project supports TWO firmware build modes:
;
;   1) NORMAL firmware
;      - Version is derived from Git tags
;      - Uploaded to PRIMARY OTAdrive product
;      - Used for everyday operation
;
;   2) SAFE / RECOVERY firmware
;      - Version is FORCE-SET to v@0.0.1
;      - Uploaded to SAFE OTAdrive product
;      - Used ONLY for crash recovery
;
; IMPORTANT:
;   Only ONE version-generation script must be enabled at a time.
;   Whichever script runs will overwrite include/FirmwareVersion.h
;
; ============================================================

[env:esp32-s3-devkitc-1]

; ------------------------------------------------------------
; Core platform / board configuration
; ------------------------------------------------------------
platform = espressif32
board = esp32-s3-devkitc-1
framework = arduino

; ------------------------------------------------------------
; Serial / upload configuration
; ------------------------------------------------------------
monitor_speed = 115200
upload_speed = 921600
monitor_filters = esp32_exception_decoder

; ------------------------------------------------------------
; Build flags
; ------------------------------------------------------------
build_flags =
    -DARDUINO_USB_MODE=1
    -DARDUINO_USB_CDC_ON_BOOT=1
    -D_ESPASYNC_WIFIMGR_LOGLEVEL_=5
    ;-DNUM_RELAYS=8                ; Uncomment if building 8-relay hardware
    -DDEBUG_WIFI
    -Iinclude

; ------------------------------------------------------------
; Version generation scripts
;
; NORMAL BUILD:
;   Uses Git tags to generate FW_VER (e.g. v@2.3.16)
;   This is the DEFAULT mode.
;
; SAFE / RECOVERY BUILD:
;   Comment out gen_fw_version.py
;   Uncomment gen_safeVersion.py
;   This forces FW_VER to v@0.0.1 so OTAdrive
;   ALWAYS offers the known-good safe firmware.
;
; ⚠️ DO NOT ENABLE BOTH SCRIPTS AT ONCE
; ------------------------------------------------------------
extra_scripts =
    pre:scripts/gen_fw_version.py      ; NORMAL firmware (Git-based version)
    ;pre:scripts/gen_safeVersion.py    ; SAFE firmware (forced v@0.0.1)
    scripts/erasefs.py

; ------------------------------------------------------------
; Filesystem / partition layout
; ------------------------------------------------------------
board_build.filesystem = littlefs
board_build.partitions = default_8MB.csv

; ------------------------------------------------------------
; Libraries to explicitly ignore
; ------------------------------------------------------------
lib_ignore =
    ESPAsync_WiFiManager
    WebServer

; ------------------------------------------------------------
; Library dependencies
; ------------------------------------------------------------
lib_deps =
    https://github.com/SmartBoat2024/SmartCore
    https://github.com/me-no-dev/ESPAsyncWebServer.git
    https://github.com/me-no-dev/AsyncTCP.git
    knolleary/PubSubClient
    bblanchon/ArduinoJson@^6.21.2
    otadrive/OTAdrive
    https://github.com/khoih-prog/ESPAsyncDNSServer.git
    links2004/WebSockets@^2.3.6
    marvinroger/AsyncMqttClient@^0.8.2
    robtillaart/MCP23008
    wollewald/MCP23017_WE@^1.3.0
    wollewald/ADS1115_WE@^1.5.4
    Ticker

; ------------------------------------------------------------
; Toolchain pin (stability + reproducibility)
; ------------------------------------------------------------
platform_packages =
    espressif/toolchain-xtensa-esp32s3@8.4.0+2021r2-patch5
